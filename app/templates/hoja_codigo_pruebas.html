{% extends "layout/layout.html" %}
{% block title %}{{ proyecto.nombre }}{% endblock %}

{% block content %}
<section id="content">
    <div class="edit-project-container">
        <div class="edit-project-header">
            <h1>{{ proyecto.nombre }}</h1>
        </div>
        <div class="edit-project-body">
            <form action="{{ url_for('editar_proyecto', proyecto_id=proyecto.id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <div class="edit-form-row">
                    <div class="edit-form-group">
                        <label for="nombre">Nombre:</label>
                        <input type="text" id="nombre" name="nombre" value="{{ proyecto.nombre }}" class="edit-input" required>
                    </div>

                    <div class="edit-form-group">
                        <label for="descripcion">Descripción:</label>
                        <input type="text" id="descripcion" name="descripcion" value="{{ proyecto.descripcion }}" class="edit-input" required>
                    </div>

                    <div class="edit-form-group">
                        <label for="cluster">Cluster:</label>
                        <select id="cluster" name="cluster" class="edit-select" required>
                            <option value="Cluster de Agua, Saneamiento e Higiene (WASH)">Cluster de Agua, Saneamiento e Higiene (WASH)</option>
                            <option value="Cluster de Alimentación y Nutrición">Cluster de Alimentación y Nutrición</option>
                            <option value="Cluster de Educación">Cluster de Educación</option>
                        </select>
                    </div>
                </div>

                <div class="edit-form-row">
                    <div class="edit-form-group">
                        <label for="responsable">Responsable:</label>
                        <input type="text" id="responsable" name="responsable" value="{{ proyecto.responsable }}" class="edit-input" required>
                    </div>

                    <div class="edit-form-group">
                        <label for="fecha_inicio">Fecha de Inicio:</label>
                        <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ proyecto.fecha_inicio }}" class="edit-input" required>
                    </div>

                    <div class="edit-form-group">
                        <label for="fecha_finalizacion">Fecha de Finalización:</label>
                        <input type="date" id="fecha_finalizacion" name="fecha_finalizacion" value="{{ proyecto.fecha_finalizacion }}" class="edit-input" required>
                    </div>
                </div>

                <div class="edit-form-row">
                    <div class="edit-form-group">
                        <label for="estado">Estado:</label>
                        <select id="estado" name="estado" class="edit-select" required>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                </div>

                <div class="edit-form-row">
                    <div class="edit-form-group">
                        <button type="submit" class="edit-submit-btn">Actualizar Proyecto</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Contenedor para los botones -->
        <div class="button-container">
            <!-- Botón para generar PDF -->
            <button id="btn-generate-pdf" class="btn-delete" onclick="generatePDF({{ proyecto.id }})">
                <i class='bx bxs-file-pdf'></i>
                <span class="text">Generar Informe PDF</span>
            </button>
            <!-- Botón 1 -->
            <button id="btn-open-modal1" class="btn-evento" onclick="openModal('myModalPreliminar')">
                <span class="text">Crear Actividad o Usuarios</span>
            </button>
            <!-- Botón 2 -->
            <button type="button" class="boton-act boton-act-secondary" data-toggle="modal" data-target="#modalSeleccionActividad">
                Seleccionar Actividades
            </button>
        </div>
        <br><br>


        <!-- Tabla para mostrar registros -->
<div class="table-data">
    <table class="table">
        <thead>
            <tr>
                <th>Nombres</th>
                <th>Apellidos</th>
                <th>Tipo de Documento</th>
                <th>Número de Documento</th>
                <th>País</th>
                <th>Departamento</th>
                <th>Municipio</th>
                <th>Género</th>
                <th>Edad</th>
                <th>Grupo de Edad</th>
                <th>Grupo Étnico</th>
                <th>Discapacidad</th>
                <th>Comunidad</th>
                <th>Actividad</th>
            </tr>
        </thead>
        <tbody>
            {% for registro in registros %}
                <tr>
                    <td>{{ registro.nombres }}</td>
                    <td>{{ registro.apellidos }}</td>
                    <td>{{ registro.tipo_documento }}</td>
                    <td>{{ registro.numero_documento }}</td>
                    <td>{{ registro.pais }}</td>
                    <td>{{ registro.departamento }}</td>
                    <td>{{ registro.municipio }}</td>
                    <td>{{ registro.genero }}</td>
                    <td>{{ registro.edad }}</td>
                    <td>
                        {% if registro.grupo_edad == "menor_18" %}
                            Menor de 18
                        {% elif registro.grupo_edad == "18_49" %}
                            18 a 49
                        {% elif registro.grupo_edad == "50_mas" %}
                            50 o más
                        {% endif %}
                    </td>
                    <td>{{ registro.grupo_etnico }}</td>
                    <td>{{ registro.discapacidad }}</td>
                    <td>{{ registro.comunidad }}</td>
                    <td>{{ registro.actividad.nombre }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

                </tbody>
            </table>
        </div>
    </div>
</section>

<script>
    $(document).ready(function(){
        $('#modalSeleccionActividad').on('shown.bs.modal', function () {
            $('#actividad').focus();
        });
    });

    function openModal(modalId) {
        var modal = document.getElementById(modalId);
        modal.style.display = "block";
    }

    function closeModal(modalId) {
        var modal = document.getElementById(modalId);
        modal.style.display = "none";
    }

    function generatePDF(proyectoId) {
        window.location.href = `/generate_pdf/${proyectoId}`;
    }

    function agregarActividadesSeleccionadas() {
        const checkboxes = document.querySelectorAll('#actividadForm input[type="checkbox"]:checked');
        const form = document.querySelector('form[action="{{ url_for('editar_proyecto', proyecto_id=proyecto.id) }}"]');

        checkboxes.forEach(checkbox => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'actividades[]';
            input.value = checkbox.value;
            form.appendChild(input);
        });

        $('#modalSeleccionActividad').modal('hide');
    }

    function openUserForm() {
        closeModal('myModalActivity');

        fetch('/get_activities')
            .then(response => response.json())
            .then(data => {
                var select = document.getElementById('actividad');
                select.innerHTML = "";
                var defaultOption = document.createElement('option');
                defaultOption.text = "Seleccione una actividad";
                select.add(defaultOption);
                data.forEach(actividad => {
                    var option = document.createElement('option');
                    option.value = actividad.nombre;
                    option.text = actividad.nombre;
                    select.add(option);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar las actividades.');
            });

        openModal('myModal1');
    }

    function openActivityModal(activityId) {
        var modalId = 'myModalActivity' + activityId;
        openModal(modalId);
    }

    {% for actividad in actividades %}
        var btnActividad{{ actividad.id }} = document.getElementById('btn-actividad-{{ actividad.id }}');
        btnActividad{{ actividad.id }}.addEventListener('click', function() {
            var modalId = this.getAttribute('data-target');
            openModal(modalId);
        });
    {% endfor %}

    function crearActividad(event) {
        event.preventDefault();

        var formData = new FormData(document.getElementById("crearActividadForm"));

        fetch('/guardar_actividad', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-Token': '{{ csrf_token() }}'
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                console.error("Error al crear la actividad.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }

    document.getElementById("crearActividadForm").addEventListener("submit", crearActividad);

    function asignarActividad(event, actividadId) {
        event.preventDefault();

        var formData = new FormData();
        formData.append('actividad_id', actividadId);
        formData.append('proyecto_id', {{ proyecto.id }});
        formData.append('csrf_token', '{{ csrf_token() }}');

        fetch('/asignar_actividad', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                console.error("Error al asignar la actividad.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }
</script>
{% endblock %}
